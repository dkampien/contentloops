# Info Hierarchy: Problem Mental Space

The mental model for understanding the ML-powered paywall personalization problem.

---

## BUSINESS LAYER

```
├── Goal: $40M ARR
├── Lever: $3M/month ad spend efficiency
└── Problem: Context gap between ad → app experience
    ├── Attribution delays (iOS privacy)
    │   ├── CAPI: ~30 min delay for raw events (confirmed via AdLoops)
    │   └── SKAN: 24-48h+ for attributed signals (not verified — need to check)
    │   └── [Open: Is pLTV/synthetic signal needed? Depends on SKAN reality]
    └── Generic app experience → low Paywall→Trial conversion
        ├── Trial→Paid is ~40% US (high, not the bottleneck)
        └── Bottleneck is earlier: Paywall→Trial
```

---

## SOLUTION LAYER

```
├── Solution 1: Contextual App Experience (Product)
│   ├── Show right paywall to right user
│   ├── Tier 0 (deep link routing) already live
│   └── Tier 2 (ML) adds user history for individual personalization
│
└── Solution 2: Synthetic Signal / pLTV (Marketing)
    ├── Send early conversion signal to ad networks
    └── [Open: Is this needed? Depends on SKAN verification]
```

---

## USER SEGMENTATION

```
├── New Users (cold start)
│   ├── Data available: Ad intent (deep link)
│   │   └── [Assumption: deep link stripping — not verified, may be stable]
│   ├── Current: Tier 0 live (deep link task queue routes experience)
│   └── Challenge: No history, same ad → same experience for all
│
└── Returning Users (PoC scope)
    ├── Data available:
    │   ├── Hot: Ad intent (deep link)
    │   └── Cold: User history (BigQuery)
    ├── Approach: ML prediction (Tier 2)
    └── Value: Personalize within same ad campaign based on individual history
```

---

## USER DATA LAYERS (The Permutation Problem)

Based on BCEvents schema. Source: BigQuery (access pending).

```
├── User Attributes: age, gender, language, denomination, lifeChallenge, preferredTopics
├── Acquisition/Intent: deepLinkOpen, campaignDisplayed (source, campaign_id)
├── Transactional: paywallShown, purchaseCompleted (price, product, trial, offeringId)
├── Engagement: habitDone, dayDone, studyItemDone, bibleScreen, audioListen
├── AI Chat: askChatGPT (category, subcategory)
├── Aha Moments: high-value signals (ahaBedtimeStories, ahaGuidedBreathing, etc.)
│
└── Result: Too many permutations → manual mapping impossible → need ML
```

---

## ML SYSTEM

```
├── Inputs
│   ├── Ad intent (deep link) — feature (e.g., lockscreen), not topic
│   └── User history (BigQuery) — user data layers above
│
├── Outputs (Predictions)
│   ├── Price Point or Tier: maps to 7+ SKUs
│   ├── Billing Cycle: Weekly / Monthly / Yearly
│   ├── Product Tier: Lite / Standard / Premium / Elite
│   └── P(conversion): 0.0 - 1.0
│       └── [PoC gap: Currently predicts engagement, not conversion. Needs PQL fix]
│
├── [Gap: What prediction heads are most valuable? Needs research]
└── Result: Paywall config JSON
```

---

## IMPLEMENTATION TIERS

```
├── Tier 0: Manual Contextualization (no ML) — LIVE
│   ├── Deep link task queue routes to specific placement
│   └── Adapty returns config for that placement
│
├── Tier 1: Clustering (batch ML)
│   └── Group users into segments, assign paywalls
│
├── Tier 2: Modular (batch ML, pre-computed) ← PoC Target
│   ├── Multi-head prediction → assemble config
│   └── Sync predictions to Adapty nightly
│
└── Tier 3: Generative (future)
    └── LLM generates bespoke UI (requires custom renderer)
```

---

## APP EXPERIENCE COMPONENTS

Based on codebase scans of BibleChat, AdLoops, and Onboarding Builder repos. Needs team verification.

```
├── Control Systems (fragmented)
│   ├── Adapty — paywall configs, 22 placements
│   ├── Firebase RemoteConfig — feature flags, onboarding type, age-based variants
│   ├── AdLoops — deep link generation, Adapty webhook forwarding
│   └── Onboarding Builder — visual CMS for onboarding screens (JSON output)
│
├── Paywalls (Adapty)
│   ├── 22 placements (ios-onboarding, premium, lockscreen, etc.)
│   ├── Flow: placementId → Adapty.getPaywall() → Config
│   ├── User attributes synced: age (birthday), gender, custom attributes
│   └── Age-based variants via Firebase RemoteConfig (6 age groups)
│
├── Onboardings
│   ├── Created in: Onboarding Builder (visual CMS)
│   ├── Output: JSON configs (elements: container, text, image, button)
│   ├── Variants: 6 age groups + onboarding types (v8.1, v9, v9_1, adapty)
│   ├── Multi-language: DeepL translation
│   └── Published to AdLoops → assigned to features
│
├── Deep Links
│   ├── Generated by: AdLoops (Singular API)
│   ├── Format: base64-encoded JSON task queue
│   ├── 30+ task types (onboarding, showPaywall, trackCampaign, etc.)
│   └── Flow: Ad click → Singular link → App parses task queue → Executes
│
├── ML Tier 2 Insertion Point
│   ├── Sync predictions to Adapty profile (updateProfile)
│   └── Adapty audience rules select paywall variant based on ML attributes
│
├── Control Systems Interaction (traced)
│   ├── Firebase picks the path (onboarding_type, age-based keys)
│   ├── Adapty serves the content (getPaywall, getOnboarding)
│   ├── Deep link can override both (task queue forces specific flow)
│   ├── Tasks execute sequentially (hardcoded)
│   └── See: _docs/2_reference-docs/control-systems-trace.md
│
└── [Open: Are there other experience types beyond paywalls + onboardings?]
```

---

## DELIVERY / RENDERING (Future State — ML Enabled)

```
├── ML Predictions Flow
│   ├── Nightly batch: BigQuery → Kumo → Predictions
│   ├── Sync to Adapty: updateProfile(price_tier, offer_type, etc.)
│   └── Result: User profile has ML attributes for audience rules
│
├── Adapty Modes
│   ├── Visual Builder Mode (Tier 2)
│   │   ├── Manually create 5-10 templates in dashboard
│   │   ├── AdaptyUI renders automatically (no code)
│   │   ├── ML selects which template via audience rules
│   │   └── Limitation: No API — can't generate layouts programmatically
│   │
│   └── Remote Config Mode (Tier 3 path)
│       ├── Raw JSON, API accessible
│       ├── LLM can generate configs
│       └── Limitation: Must build custom renderer in Swift
│
├── Alternative Routes (Unexplored)
│   ├── Figma API — generate/export UI programmatically?
│   ├── Custom SwiftUI Assembler — parse JSON, render dynamically
│   └── Onboarding Builder — already generates JSON, could extend?
│
├── PoC Approach
│   └── Abstract HTML viewer with color blocks (proves Brain → Screen)
│
└── Decision
    ├── December: Tier 2 (Visual Builder, manual templates)
    └── Future: Tier 3 requires custom renderer investment
```

---

## OPEN QUESTIONS / RESEARCH NEEDED

```
├── pLTV / SKAN (partially researched)
│   ├── SKAN is handled passively by Singular SDK
│   │   ├── App sends events → Singular sets conversion values → Apple → Ad networks
│   │   ├── 46 ad networks configured in Info.plist
│   │   ├── No direct SKAdNetwork API calls in app
│   │   └── TikTok SKAN explicitly disabled
│   ├── Current: Singular auto-calculates conversion values from purchases
│   ├── pLTV would: Predict user value at minute 5, send BEFORE purchase
│   └── [Open: Is Singular's auto handling sufficient? Ask team]
│
├── Prediction Heads
│   ├── What's most valuable to predict?
│   ├── Given 7+ SKUs, is binary price_tier useful?
│   └── What prediction would move Paywall→Trial the most?
│
├── ~~Deep Link Stripping~~ → Resolved
│   ├── Confirmed: Deep links preserve params
│   ├── Tier 0 works reliably — users get full task queue
│   └── Original assumption was wrong
│
├── App Experience Types
│   └── Are there other types beyond paywalls + onboardings?
│
├── Adapty Dashboard
│   ├── What audience rules are configured today?
│   ├── Are topics synced to Adapty profiles?
│   └── What A/B tests are running?
│
└── ~~Control Systems Interaction~~ → Resolved, see APP EXPERIENCE COMPONENTS
```

---

## Notes

- This hierarchy represents the **problem mental space**, not the solution
- Strategy v3 builds on top of this foundation
- Delta file (`strategy-v3-delta.md`) captures what changed — now merged here
- PoC scope is in strategy-v3, not duplicated here

---

*Last updated: 2025-12-17*
