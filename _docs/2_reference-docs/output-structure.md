# Output Directory Structure

**Version**: 1.0
**Last Updated**: 2025-10-27

---

## Overview

This document describes the complete output directory structure generated by the video generation pipeline. All outputs are timestamped to prevent overwrites and preserve generation history.

---

## Complete Directory Tree

```
output/
├── manifests/                                    # Per-video JSON manifests
│   ├── dry-run_{videoId}_{timestamp}.json      # Dry-run manifests (script only)
│   └── {videoId}_{timestamp}.json               # Full-run manifests (with videos)
│
├── videos/                                       # Video assets
│   └── {videoId}_{timestamp}/                   # Timestamped video folder
│       ├── scenes/                              # Individual 8s scene clips
│       │   ├── scene1.mp4
│       │   ├── scene2.mp4
│       │   └── scene3.mp4
│       ├── frames/                              # Extracted frames for chaining
│       │   ├── scene1_last.jpg                  # Last frame of scene 1
│       │   └── scene2_last.jpg                  # Last frame of scene 2
│       ├── concat.txt                           # ffmpeg concat file
│       └── final.mp4                            # Combined 24s video
│
├── state.json                                    # Pipeline state (for resumability)
└── final-output.json                             # Aggregate output (all videos)
```

---

## Manifests Directory

### Purpose
Stores per-video JSON manifests with complete metadata. Primary integration point for the parent platform.

### File Naming

**Dry-Runs**:
```
dry-run_{videoId}_{timestamp}.json
```

**Example**:
```
dry-run_anxiety-or-fear_direct-to-camera_2025-10-27T14-32-15-123Z.json
```

**Full Runs**:
```
{videoId}_{timestamp}.json
```

**Example**:
```
anxiety-or-fear_direct-to-camera_2025-10-27T14-32-15-123Z.json
```

### Structure
See [Manifest Schema](./manifest-schema.md) for complete details.

---

## Videos Directory

### Purpose
Stores all video assets: individual scenes, extracted frames, and combined final video.

### Folder Structure

Each video generation creates a **timestamped folder**:
```
videos/{videoId}_{timestamp}/
```

**Example**:
```
videos/anxiety-or-fear_direct-to-camera_2025-10-27T14-32-15-123Z/
```

**Benefits**:
- ✅ No overwrites (each run is separate)
- ✅ Full history preserved
- ✅ Easy to identify which generation
- ✅ Matches manifest timestamp

### Subdirectories

#### `scenes/`
Contains the 3 individual scene videos (8 seconds each):

```
scenes/
├── scene1.mp4  # First 8 seconds
├── scene2.mp4  # Middle 8 seconds
└── scene3.mp4  # Final 8 seconds
```

**Format**:
- Duration: 8 seconds
- Aspect ratio: 9:16 (vertical)
- Resolution: 720p (configurable)
- Audio: Generated by Veo (dialogue + ambient)

#### `frames/`
Contains extracted frames used for frame chaining:

```
frames/
├── scene1_last.jpg  # Last frame of scene 1 (for scene 2)
└── scene2_last.jpg  # Last frame of scene 2 (for scene 3)
```

**Technical Details**:
- Format: JPEG
- Frame: Frame 191 (last frame @ 24fps for 8s video)
- Size: Typically 50-150KB
- Usage: Converted to base64 data URLs for Replicate API

**Why No scene3_last.jpg?**
Scene 3 is the final scene, so no frame chaining is needed after it.

#### Root Files

**`concat.txt`** - ffmpeg concat file:
```
file 'scenes/scene1.mp4'
file 'scenes/scene2.mp4'
file 'scenes/scene3.mp4'
```

**`final.mp4`** - Combined 24-second video:
- Duration: 24 seconds (3 × 8s)
- All 3 scenes concatenated
- Created with `ffmpeg -c copy` (no re-encoding)

---

## State File

### `state.json`

**Purpose**: Tracks pipeline execution state for resumability.

**Location**: `output/state.json`

**Structure**:
```json
{
  "startedAt": "2025-10-27T14:32:15.123Z",
  "lastUpdated": "2025-10-27T14:45:22.456Z",
  "status": "processing",
  "currentStep": "Generating content",
  "progress": {
    "totalVideos": 10,
    "completedVideos": 3,
    "totalClips": 30,
    "completedClips": 9
  },
  "videos": [
    {
      "id": "anxiety-or-fear_direct-to-camera",
      "videoFolderName": "anxiety-or-fear_direct-to-camera_2025-10-27T14-32-15-123Z",
      "category": "Anxiety or fear",
      "template": "direct-to-camera",
      "status": "completed",
      "manifestPath": "output/manifests/anxiety-or-fear_direct-to-camera_2025-10-27T14-32-15-123Z.json",
      "finalVideoPath": "output/videos/anxiety-or-fear_direct-to-camera_2025-10-27T14-32-15-123Z/final.mp4",
      "scenes": [...]
    }
  ],
  "errors": []
}
```

**Usage**:
```bash
# Resume interrupted generation
npm start generate -- --resume
```

---

## Final Output File

### `final-output.json`

**Purpose**: Aggregate output file with all completed videos and metadata.

**Location**: `output/final-output.json`

**Structure**:
```json
{
  "generatedAt": "2025-10-27T14:45:22.456Z",
  "summary": {
    "totalVideos": 10,
    "totalClips": 30,
    "successfulClips": 28,
    "failedClips": 2
  },
  "videos": [
    {
      "id": "anxiety-or-fear_direct-to-camera",
      "category": "Anxiety or fear",
      "template": "direct-to-camera",
      "clips": [
        {
          "sceneNumber": 1,
          "videoPath": "output/videos/anxiety-or-fear_direct-to-camera_2025-10-27T.../scenes/scene1.mp4",
          "prompt": "Person in their 40s...",
          "duration": 8,
          "metadata": {
            "predictionId": "abc123",
            "generatedAt": "2025-10-27T14:35:10.123Z"
          }
        }
      ]
    }
  ]
}
```

**Note**: This is a legacy format from earlier cycles. The **manifest files** are now the primary integration point.

---

## Example: Complete Output

After running:
```bash
npm start generate -- --template direct-to-camera --limit 2
```

You get:

```
output/
├── manifests/
│   ├── anxiety-or-fear_direct-to-camera_2025-10-27T14-32-15-123Z.json
│   └── finances-or-provision_direct-to-camera_2025-10-27T14-35-42-789Z.json
│
├── videos/
│   ├── anxiety-or-fear_direct-to-camera_2025-10-27T14-32-15-123Z/
│   │   ├── scenes/
│   │   │   ├── scene1.mp4
│   │   │   ├── scene2.mp4
│   │   │   └── scene3.mp4
│   │   ├── frames/
│   │   │   ├── scene1_last.jpg
│   │   │   └── scene2_last.jpg
│   │   └── final.mp4
│   │
│   └── finances-or-provision_direct-to-camera_2025-10-27T14-35-42-789Z/
│       ├── scenes/
│       │   ├── scene1.mp4
│       │   ├── scene2.mp4
│       │   └── scene3.mp4
│       ├── frames/
│       │   ├── scene1_last.jpg
│       │   └── scene2_last.jpg
│       └── final.mp4
│
├── state.json
└── final-output.json
```

---

## Dry-Run Output

After running:
```bash
npm start generate -- --dry-run --template direct-to-camera --limit 1
```

You get:

```
output/
├── manifests/
│   └── dry-run_anxiety-or-fear_direct-to-camera_2025-10-27T14-32-15-123Z.json
│
├── state.json (not created in dry-run)
└── final-output.json (not created in dry-run)
```

**Note**: No videos are generated in dry-run mode, only the manifest with script and prompts.

---

## Cleanup & Maintenance

### Disk Space Management

Each full video generation uses approximately:
- Scenes: 3 × ~5MB = ~15MB
- Frames: 2 × ~100KB = ~200KB
- Final video: ~15MB
- **Total per video**: ~30MB

**With 100 videos**: ~3GB disk space

### Cleaning Old Generations

```bash
# Remove all old generations (keep only latest)
find output/manifests -name "*.json" | sort | head -n -1 | xargs rm
find output/videos -mindepth 1 -maxdepth 1 -type d | sort | head -n -1 | xargs rm -rf

# Remove only dry-runs
rm output/manifests/dry-run_*.json

# Remove all generated content
rm -rf output/manifests/* output/videos/*
```

---

## Integration Guidelines

### For Parent Platform

**Primary data source**: Manifest files in `output/manifests/`

**Workflow**:
1. List completed manifests:
   ```bash
   find output/manifests -name "*.json" -not -name "dry-run_*"
   ```

2. Parse each manifest:
   ```javascript
   const manifest = JSON.parse(fs.readFileSync(manifestPath));

   if (manifest.status === 'completed') {
     const videoPath = manifest.finalVideoPath;
     const metadata = {
       category: manifest.problemCategory,
       template: manifest.contentTemplate,
       voiceScript: manifest.content.voiceScript,
       scenes: manifest.scenes
     };

     // Process video and metadata
   }
   ```

3. Track by timestamp:
   ```javascript
   const timestamp = manifest.timestamp;
   const videoFolderName = path.basename(
     path.dirname(manifest.finalVideoPath)
   );
   // Use for archival, versioning, etc.
   ```

---

## Related Documentation

- [Manifest Schema](./manifest-schema.md) - Complete manifest structure
- [Zod Schemas](./zod-schemas.md) - LLM response validation
- [Technical Specs](../1_development-docs/core-docs/3-technical-specs.md) - System architecture
- [Cycle 4 Implementation](../1_development-docs/cycle-4/IMPLEMENTATION-COMPLETE.md) - Implementation details
